<!DOCTYPE html>
<html lang="en">

<head>
    {{ template "head.html" }}
</head>

<body class="min-h-screen bg-gray-50 p-4" data-page="year">
    <!-- Navbar -->
    {{template "nav.html" .}}

    <main class="w-full max-w-screen-lg mx-auto space-y-6 bg-white shadow rounded-xl p-6">
        <h1 class="text-2xl font-semibold text-center">Annual Weather Summary</h1>

        <div class="space-y-3">
            <!-- Search (locations or postal codes) -->
            <div class="grid grid-cols-3 gap-3 items-start">
                <label for="station-search" class="col-span-1 font-medium pt-2">Search</label>

                <div class="col-span-2">
                    <div class="flex items-center gap-2">
                        <input id="station-search" name="q" type="search" placeholder="'3004' or 'Bern'"
                            class="border rounded p-2 w-full" autocomplete="off" spellcheck="false"
                            hx-get="/stations/search" hx-trigger="input changed delay:400ms, search"
                            hx-target="#search-results" />
                    </div>
                    <div id="search-results"></div>
                </div>
            </div>

            <!-- Controls -->
            <form class="space-y-3" id="chart-controls">

                <!-- Station -->
                <div class="grid grid-cols-3 gap-3 items-start">
                    <label for="station" class="col-span-1 font-medium pt-2">Station</label>

                    <select id="station" name="station" class="col-span-2 border rounded p-2 w-full">
                        {{$selected := .Query.station}}
                        {{range .Stations}}
                        <option value="{{.Abbr}}" {{if eq .Abbr $selected}}selected{{end}}>{{.Name}} {{.Canton}}
                            ({{.Abbr}})
                        </option>
                        {{end}}
                    </select>
                </div>

                <!-- Year picker -->
                <div class="grid grid-cols-3 gap-3 items-start">
                    <label for="year" class="col-span-1 font-medium pt-2">Year</label>
                    <div class="col-span-2 flex gap-3 items-center">
                        <button type="button" id="prev-year" class="border rounded px-3 py-2 text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor" class="size-6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
                            </svg>
                        </button>
                        <input type="text" id="year" name="year" placeholder="Pick year" value="{{.Query.year}}"
                            class="border rounded p-2 w-full">

                        <button type="button" id="current-year" class="border rounded px-3 py-2 text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth="1.5"
                                stroke="currentColor" class="size-6">
                                <path strokeLinecap="round" strokeLinejoin="round"
                                    d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                            </svg>
                        </button>
                        <button type="button" id="next-year" class="border rounded px-3 py-2 text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor" class="size-6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" />
                            </svg>
                        </button>
                    </div>
                </div>

            </form>
        </div>


        <!-- Stats table -->
        <div>
            <div id="year-stats-container" hx-ext="path-params" hx-trigger="change from:#chart-controls"
                hx-get="/stations/{station}/stats/year/{year}/highlights" hx-include="#chart-controls" hx-target="this"
                hx-swap="innerHTML">
            </div>
        </div>

        <!-- Charts -->

        <!-- Dry / wet spells -->
        <h2 class="text-lg font-medium text-gray-800 mt-6 mb-2">Dry / wet spells</h2>
        <p class="text-sm text-gray-600 leading-relaxed mb-4">
            Amount of rainfall and percentage of possible sunshine for each day of the selected year.
        </p>
        <!-- Expandable legend -->
        <div class="mb-8">
            <button id="drywet-legend-toggle"
                class="text-sm font-medium text-gray-700 hover:text-gray-900 focus:outline-none mb-2">
                Show legend &#9658;
            </button>

            <div id="drywet-legend-content" class="hidden">
                <table class="text-sm text-left text-gray-700 border border-gray-200 rounded-md w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-2 w-4"></th>
                            <th class="px-3 py-2">Description</th>
                            <th class="px-3 py-2">Condition</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="border-t">
                            <td class="px-3 py-2">
                                <div class="w-4 h-4 rounded-sm" style="background-color: #e07000;"></div>
                            </td>
                            <td class="px-3 py-2">Dry · sunny</td>
                            <td class="px-3 py-2">Precip. &lt; 0.2 mm and sunshine &gt; 90%</td>
                        </tr>
                        <tr class="border-t">
                            <td class="px-3 py-2">
                                <div class="w-4 h-4 rounded-sm" style="background-color: #f18e1c;"></div>
                            </td>
                            <td class="px-3 py-2">Dry · mostly sunny</td>
                            <td class="px-3 py-2">Precip &lt; 0.2 mm and sunshine 60-90%</td>
                        </tr>
                        <tr class="border-t">
                            <td class="px-3 py-2">
                                <div class="w-4 h-4 rounded-sm" style="background-color: #fbb65c;"></div>
                            </td>
                            <td class="px-3 py-2">Dry · partly sunny</td>
                            <td class="px-3 py-2">Precip. &lt; 0.2 mm and sunshine 30-60%</td>
                        </tr>
                        <tr class="border-t">
                            <td class="px-3 py-2">
                                <div class="w-4 h-4 rounded-sm" style="background-color: #fde1b0;"></div>
                            </td>
                            <td class="px-3 py-2">Dry · mostly cloudy</td>
                            <td class="px-3 py-2">Precip. &lt; 0.2 mm and sunshine 10-30%</td>
                        </tr>
                        <tr class="border-t">
                            <td class="px-3 py-2">
                                <div class="w-4 h-4 rounded-sm" style="background-color: #f2f2f2;"></div>
                            </td>
                            <td class="px-3 py-2">Very overcast / light rain</td>
                            <td class="px-3 py-2">Precip. &lt; 0.2 mm and sunshine &lt; 10% <em>or</em> Precip. ≥ 0.2 mm
                                and &lt; 1 mm</td>
                        </tr>
                        <tr class="border-t">
                            <td class="px-3 py-2">
                                <div class="w-4 h-4 rounded-sm" style="background-color: #d2e5ef;"></div>
                            </td>
                            <td class="px-3 py-2">Rain 1–4 mm</td>
                            <td class="px-3 py-2">Precip. ≥ 1 mm and &lt; 4 mm</td>
                        </tr>
                        <tr class="border-t">
                            <td class="px-3 py-2">
                                <div class="w-4 h-4 rounded-sm" style="background-color: #9dcae1;"></div>
                            </td>
                            <td class="px-3 py-2">Rain 4–8 mm</td>
                            <td class="px-3 py-2">Precip. ≥ 4 mm and &lt; 8 mm</td>
                        </tr>
                        <tr class="border-t">
                            <td class="px-3 py-2">
                                <div class="w-4 h-4 rounded-sm" style="background-color: #5da2cb;"></div>
                            </td>
                            <td class="px-3 py-2">Rain 8–12 mm</td>
                            <td class="px-3 py-2">Precip. ≥ 8 mm and &lt; 12 mm</td>
                        </tr>
                        <tr class="border-t">
                            <td class="px-3 py-2">
                                <div class="w-4 h-4 rounded-sm" style="background-color: #2f78b3;"></div>
                            </td>
                            <td class="px-3 py-2">Rain ≥ 12 mm</td>
                            <td class="px-3 py-2">Precip. ≥ 12 mm</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div>
            <div class="mb-8">
                <div hx-ext="path-params" hx-trigger="change from:#chart-controls"
                    hx-get="/stations/{station}/charts/year/{year}/drywet" hx-include="#chart-controls" hx-target="this"
                    hx-swap="innerHTML"
                    data-vega-targets='{"drywet":"drywet-chart","drywet-spells":"drywet-spells-chart"}'>
                    <!-- Vega script goes here -->
                </div>
                <!-- Two charts, stacked: one for the dry/wet grid and one for the dry/wet spell bars. -->
                <div id="drywet-chart" class="w-full overflow-hidden"></div>
                <div id="drywet-spells-chart" class="w-full overflow-hidden"></div>
            </div>
        </div>


        <!-- Monthly temperature distribution -->
        <h2 class="text-lg font-medium text-gray-800 mt-6 mb-2">Temperature</h2>
        <p class="text-sm text-gray-600 leading-relaxed mb-4">

            Distribution of daily min/avg/max temperatures by month.
            Each <a href="https://en.wikipedia.org/wiki/Box_plot" class="text-blue-600 hover:underline"
                target="_blank">box plot</a> shows the middle 50% (the interquartile range; IQR) of temperatures for
            that month. The whiskers indicate the minimum and maximum values.
            <em>Climate normals</em>: the band shows the middle 50% (IQR) of the daily mean temperature
            in the
            <a class="text-blue-600 hover:underline" href="https://www.ncei.noaa.gov/products/wmo-climate-normals">WMO
                Climate Normals</a> period
            1991&ndash;2020, the orange line indicates its mean.
        </p>

        <!-- Tabs -- Click events are registered in "year.js" -->
        <div class="tab-widget mb-12">
            <div role="tablist" class="flex gap-2 mb-4 border-b border-gray-200">
                <!-- Min temp -->
                <button data-facet="min" data-chart-type="temperature:month" role="tab" aria-selected="false" class="px-3 py-2 text-sm font-medium border-b-2 border-transparent text-gray-600
                        hover:text-gray-800 focus:outline-none
                        aria-selected:border-blue-600 aria-selected:text-blue-600">
                    Min.&nbsp;temp
                </button>
                <!-- Mean temp -->
                <button data-facet="mean" data-chart-type="temperature:month" role="tab" aria-selected="false" class="px-3 py-2 text-sm font-medium border-b-2 border-transparent text-gray-600
                        hover:text-gray-800 focus:outline-none
                        aria-selected:border-blue-600 aria-selected:text-blue-600">
                    Avg.&nbsp;temp
                </button>
                <!-- Max temp -->
                <button data-facet="max" data-chart-type="temperature:month" role="tab" aria-selected="true" class="px-3 py-2 text-sm font-medium border-b-2 border-transparent text-gray-600
                        hover:text-gray-800 focus:outline-none
                        aria-selected:border-blue-600 aria-selected:text-blue-600">
                    Max.&nbsp;temp
                </button>
                <!-- Vs. Climate Normals 1991-2020 ref. period -->
                <button data-facet="mean" data-chart-type="temperature_normals:month" role="tab" aria-selected="false"
                    class="px-3 py-2 text-sm font-medium border-b-2 border-transparent text-gray-600
                        hover:text-gray-800 focus:outline-none
                        aria-selected:border-blue-600 aria-selected:text-blue-600">
                    Climate normals
                </button>
            </div>

            <!-- Loader: carries station+year from the global form + its own hx-vals facet -->
            <div class="vega-spec-loader" data-vega-target="temperature-month-chart"
                hx-get="/stations/{station}/charts/year/{year}/{chartType}" hx-ext="path-params"
                hx-trigger="change from:#chart-controls, refresh" hx-include="#chart-controls"
                hx-vals='{"facet":"max","chartType":"temperature:month"}' hx-target="this" hx-swap="innerHTML"></div>
            <div id="temperature-month-chart" class="w-full overflow-hidden"></div>
        </div>

        <!-- Monthly sunshine hours -->
        <h2 class="text-lg font-medium text-gray-800 mt-6 mb-2">Sunshine</h2>
        <p class="text-sm text-gray-600 leading-relaxed mb-4">
            Distribution of daily sunshine hours by month.
            <em>Sunshine hours</em>: each <a href="https://en.wikipedia.org/wiki/Box_plot"
                class="text-blue-600 hover:underline" target="_blank">box plot</a> shows the middle 50% (IQR)
            and median of daily sunshine hours. The whiskers indicate the minimum and maximum values.

            <em>Sunny days</em>:
            The light coloured boxes indicate the middle 50% (IQR) of monthly
            precipitation in the
            <a class="text-blue-600 hover:underline" href="https://www.ncei.noaa.gov/products/wmo-climate-normals">WMO
                Climate Normals</a> period
            1991&ndash;2020, the orange line indicates its mean.
        </p>

        <div class="tab-widget mb-12">
            <div role="tablist" class="flex gap-2 mb-4 border-b border-gray-200">
                <!-- Sunshine hours -->
                <button data-facet="sunshine" role="tab" aria-selected="true" class="px-3 py-2 text-sm font-medium border-b-2 border-transparent text-gray-600
                   hover:text-gray-800 focus:outline-none
                   aria-selected:border-blue-600 aria-selected:text-blue-600">
                    Sunshine hours
                </button>
                <!-- Clear (sunny) rays -->
                <button data-facet="sunny_days" role="tab" aria-selected="false" class="px-3 py-2 text-sm font-medium border-b-2 border-transparent text-gray-600
                   hover:text-gray-800 focus:outline-none
                   aria-selected:border-blue-600 aria-selected:text-blue-600">
                    Sunny days
                </button>
            </div>

            <div class="vega-spec-loader" data-vega-target="sunshine-vega-chart"
                hx-get="/stations/{station}/charts/year/{year}/{facet}:month" hx-ext="path-params"
                hx-trigger="change from:#chart-controls, refresh" hx-include="#chart-controls"
                hx-vals='{"facet":"sunshine"}' hx-target="this" hx-swap="innerHTML"></div>
            <div id="sunshine-vega-chart" class="w-full overflow-hidden"></div>
        </div>

        <!-- Monthly precipitation compared to reference period 1991-2020 -->
        <h2 class="text-lg font-medium text-gray-800 mt-6 mb-2">Precipitation</h2>
        <p class="text-sm text-gray-600 leading-relaxed mb-4">
            Total precipitation by month. The light coloured boxes indicate the middle 50% (IQR) of monthly
            precipitation in the
            <a class="text-blue-600 hover:underline" href="https://www.ncei.noaa.gov/products/wmo-climate-normals">WMO
                Climate Normals</a> period
            1991&ndash;2020, the orange line indicates its mean.
        </p>
        <div class="tab-widget mb-12">
            <div role="tablist" class="flex gap-2 mb-4 border-b border-gray-200">
                <!-- Total precipitation -->
                <button data-facet="precipitation" role="tab" aria-selected="true" class="px-3 py-2 text-sm font-medium border-b-2 border-transparent text-gray-600
                   hover:text-gray-800 focus:outline-none
                   aria-selected:border-blue-600 aria-selected:text-blue-600">
                    Precipitation
                </button>
                <!-- Rain rays -->
                <button data-facet="raindays" role="tab" aria-selected="false" class="px-3 py-2 text-sm font-medium border-b-2 border-transparent text-gray-600
                   hover:text-gray-800 focus:outline-none
                   aria-selected:border-blue-600 aria-selected:text-blue-600">
                    Rain days
                </button>
            </div>

            <!-- Loader: carries station+year from the global form + its own hx-vals facet -->
            <div class="vega-spec-loader" data-vega-target="precipitation-vega-chart"
                hx-get="/stations/{station}/charts/year/{year}/{facet}:month" hx-ext="path-params"
                hx-trigger="change from:#chart-controls, refresh" hx-include="#chart-controls"
                hx-vals='{"facet":"precipitation"}' hx-target="this" hx-swap="innerHTML"></div>
            <div id="precipitation-vega-chart" class="w-full overflow-hidden"></div>
        </div>

        <!-- Monthly humidity distribution -->
        <h2 class="text-lg font-medium text-gray-800 mt-6 mb-2">Relative humidity</h2>
        <p class="text-sm text-gray-600 leading-relaxed mb-4">
            Distribution of daily average relative humidity by month.
            Each <a href="https://en.wikipedia.org/wiki/Box_plot" class="text-blue-600 hover:underline"
                target="_blank">box plot</a> shows the middle 50% (IQR) of daily relative humidity
            for that month. The whiskers indicate the minimum and maximum values.
        </p>
        <div>
            <div class="mb-8">
                <div hx-ext="path-params" hx-trigger="change from:#chart-controls"
                    hx-get="/stations/{station}/charts/year/{year}/humidity:month" hx-include="#chart-controls"
                    hx-target="this" hx-swap="innerHTML" data-vega-target="humidity-month-chart">
                    <!-- Vega script goes here -->
                </div>
                <div id="humidity-month-chart" class="w-full overflow-hidden"></div>
            </div>
        </div>

        <h2 class="text-lg font-medium text-gray-800 mt-6 mb-2">Wind</h2>
        <p class="text-sm text-gray-600 leading-relaxed mb-4">
            <a href="https://en.wikipedia.org/wiki/Wind_rose" class="text-blue-600 hover:underline">Wind rose</a>
            showing the annual distribution of hourly average wind directions and speeds.
            The wind direction indicates where the wind is <em>coming</em> from.
        </p>
        <div>
            <div class="mb-8">
                <div hx-ext="path-params" hx-trigger="change from:#chart-controls"
                    hx-get="/stations/{station}/charts/year/{year}/windrose" hx-include="#chart-controls"
                    hx-target="this" hx-swap="innerHTML" data-vega-target="windrose-chart">
                    <!-- Vega script goes here -->
                </div>
                <!-- This is a Vega chart created without Altair, so we must set the (min-) height
                     explicitly. Re: consistency with other charts shown on this page:
                     Altair uses config.view.continuousHeight: 300 in its default theme:
                     https://altair-viz.github.io/user_guide/customization.html#chart-themes
                -->
                <div id="windrose-chart" class="min-h-[400px] w-full overflow-hidden"></div>
            </div>
        </div>
    </main>


    <footer>
        {{template "disclaimer.html" .}}
    </footer>

    <script type="module" src='{{assetHash "/static/dist/main.js"}}'></script>

</body>

</html>